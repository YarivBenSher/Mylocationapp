<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Map Application</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
        }
        .map-container {
            width: 100%;
            height: 500px;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* Ensure right-to-left text for device language if applicable */
        [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        /* Language buttons container */
        .language-buttons {
            position: absolute;
            top: -50px; /* Approx. 5 cm above the map container */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        /* Language button styling */
        .language-button {
            width: 32px;
            height: 32px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .language-button:hover {
            transform: scale(1.1);
            background-color: #555;
        }
        .language-button.selected {
            background-color: #333;
            border: 2px solid #fff;
        }
        /* Exit button styling */
        .exit-button {
            position: absolute;
            top: -50px; /* Approx. 5 cm above the map container */
            left: 10px;
            width: 48px;
            height: 48px;
            background-image: url('https://www.iconarchive.com/download/i51095/oxygen-icons.org/oxygen/Actions-system-shutdown.ico');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .exit-button:hover {
            transform: scale(1.1);
        }
        /* Shutdown notice styling */
        .shutdown-notice {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 24px;
            color: #333;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Live Interactive Map</h1>
    <div class="map-wrapper">
        <div class="language-buttons">
            <button class="language-button" id="lang-en" onclick="setLanguage('en')">EN</button>
            <button class="language-button" id="lang-device" onclick="setLanguage('device')"></button>
        </div>
        <button class="exit-button" onclick="shutdownApp()" title="Exit Application"></button>
        <div class="map-container" id="map-container">
            <div id="map"></div>
        </div>
    </div>
    <script>
        // Initialize the map with a default location (fallback)
        let map = L.map('map').setView([51.505, -0.09], 13); // Centered on London
        let marker;
        let isAppRunning = true;
        let currentLanguage = 'device'; // Default to device language
        let deviceLang = navigator.language || navigator.userLanguage || 'en';
        deviceLang = deviceLang.split('-')[0]; // Simplify to primary language code

        // Set the device language button text
        document.getElementById('lang-device').textContent = deviceLang.toUpperCase();

        // Function to set the language and update button styles
        function setLanguage(lang) {
            currentLanguage = lang;
            // Update selected button styling
            document.getElementById('lang-en').classList.toggle('selected', lang === 'en');
            document.getElementById('lang-device').classList.toggle('selected', lang === 'device');
            updateMapLanguage();
        }

        // Function to update map language and marker
        function updateMapLanguage() {
            if (!isAppRunning) return;

            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;

            // Set text direction for right-to-left languages
            const isRTL = ['ar', 'he', 'fa', 'ur'].includes(lang); // Example RTL languages
            document.getElementById('map').setAttribute('dir', isRTL ? 'rtl' : 'ltr');

            // Remove existing marker and tile layer
            if (marker) marker.remove();
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) map.removeLayer(layer);
            });

            // Add OpenStreetMap tiles with language-specific attribution
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: lang === 'en'
                    ? '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    : lang === 'he'
                    ? 'נתוני מפה © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    : `Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> (${lang})`,
                maxZoom: 19,
            }).addTo(map);

            // Customize popup based on language
            const popupText = lang === 'en'
                ? (window.currentLocation ? 'Your current location!' : 'Default location (London)') + '<br> You can zoom and pan the map.'
                : lang === 'he'
                ? (window.currentLocation ? 'המיקום הנוכחי שלך!' : 'מיקום ברירת מחדל (לונדון)') + '<br> ניתן להתקרב ולהזיז את המפה.'
                : (window.currentLocation ? `Your location (${lang})` : `Default location (${lang})`) + '<br>Zoom and pan the map.';

            // Update marker with current or default location
            const location = window.currentLocation || [51.5, -0.09];
            marker = L.marker(location).addTo(map)
                .bindPopup(popupText)
                .openPopup();
        }

        // Function to shut down the application
        function shutdownApp() {
            isAppRunning = false;
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;

            // Remove map and marker
            if (marker) marker.remove();
            map.remove();
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = '';

            // Display shutdown notice
            const notice = lang === 'en'
                ? 'Application will be closed for 2 min'
                : lang === 'he'
                ? 'היישום ייסגר למשך 2 דקות'
                : `Application will be closed for 2 min (${lang})`;
            const noticeDiv = document.createElement('div');
            noticeDiv.className = 'shutdown-notice';
            noticeDiv.textContent = notice;
            mapContainer.appendChild(noticeDiv);

            // Attempt to close the window after 2 minutes (120 seconds)
            setTimeout(() => {
                window.close();
                // Fallback message if window.close() fails
                const fallbackMessage = lang === 'en'
                    ? 'Please close the window manually'
                    : lang === 'he'
                    ? 'אנא סגור את החלון ידנית'
                    : `Please close the window manually (${lang})`;
                noticeDiv.textContent = fallbackMessage;
            }, 120000); // 120 seconds
        }

        // Function to get current location
        function getCurrentLocation() {
            // Check for secure context (HTTPS)
            if (window.location.protocol !== 'https:') {
                alert('This application requires a secure connection (HTTPS) to access your location. Please host the app on an HTTPS server or use a service like GitHub Pages.');
                window.currentLocation = null;
                updateMapLanguage();
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        window.currentLocation = [latitude, longitude];
                        map.setView(window.currentLocation, 13); // Center map on user location
                        updateMapLanguage(); // Update map with new location
                    },
                    error => {
                        let errorMessage = 'Unable to retrieve location. Using default location (London).';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location permission denied. Please allow location access in your browser settings and refresh the page.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information is unavailable. Please ensure location services are enabled on your device.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out. Please check your network connection and try again.';
                                break;
                            default:
                                errorMessage = 'An unknown error occurred while retrieving location.';
                                break;
                        }
                        console.error('Geolocation error:', error);
                        alert(errorMessage);
                        window.currentLocation = null;
                        updateMapLanguage();
                    },
                    {
                        enableHighAccuracy: true, // Try to get precise location (GPS if available)
                        timeout: 10000, // 10-second timeout
                        maximumAge: 0 // Don't use cached location
                    }
                );
            } else {
                console.error('Geolocation not supported');
                alert('Geolocation is not supported by your browser. Using default location (London).');
                window.currentLocation = null;
                updateMapLanguage();
            }
        }

        // Set default to device language and get location
        setLanguage('device'); // Default to device language
        getCurrentLocation();
    </script>
</body>
</html>