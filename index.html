<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Live-Runners Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* Ensure right-to-left text for applicable languages */
        [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        /* Button bar container (language buttons and menu button) */
        .button-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 1000;
        }
        /* Shared button styling */
        .button-bar button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        /* Language button styling */
        .language-button, .menu-button {
            background-color: #666;
            color: white;
        }
        .language-button:hover, .menu-button:hover {
            background-color: #555;
        }
        .language-button.selected {
            background-color: #333;
            border: 2px solid #fff;
        }
        /* Popup menu styling */
        .popup-menu {
            display: none;
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            min-width: 200px;
        }
        .popup-menu.open {
            display: block;
        }
        .popup-menu div {
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        .popup-menu div:hover {
            background-color: #555;
        }
        /* Map mode sub-menu styling */
        .map-mode-options {
            display: none;
            padding-left: 20px;
        }
        .map-mode-options.open {
            display: block;
        }
        .map-mode-options label {
            display: block;
            padding: 5px 0;
            cursor: pointer;
        }
        .map-mode-options input[type="radio"] {
            margin-right: 5px;
        }
        /* Custom marker popup styling */
        .custom-marker-popup {
            text-align: center;
        }
        .custom-marker-popup h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .custom-marker-popup button {
            background-color: #666;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .custom-marker-popup button:hover {
            background-color: #555;
        }
        /* Thank you message styling */
        .thank-you-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 24px;
            color: #333;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1 id="page-heading">Live-Runners Map</h1>
    <div class="map-wrapper">
        <div class="map-container" id="map-container">
            <div class="button-bar">
                <button class="language-button" id="lang-en" onclick="setLanguage('en')">EN</button>
                <button class="language-button" id="lang-device" onclick="setLanguage('device')"></button>
                <button class="menu-button" id="menu-btn">☰</button>
            </div>
            <div id="map"></div>
            <!-- Popup menu -->
            <div class="popup-menu" id="popup-menu">
                <div id="add-position" onclick="addPosition()">Add Position</div>
                <div id="remove-all-positions" onclick="removeAllPositions()">Remove All Positions</div>
                <div id="map-mode" onclick="toggleMapModeOptions()">Map Mode</div>
                <div class="map-mode-options" id="map-mode-options">
                    <label><input type="radio" name="map-mode" value="roadmap" checked onclick="changeMapMode('roadmap')"> Roadmap</label>
                    <label><input type="radio" name="map-mode" value="satellite" onclick="changeMapMode('satellite')"> Satellite</label>
                    <label><input type="radio" name="map-mode" value="hybrid" onclick="changeMapMode('hybrid')"> Hybrid</label>
                </div>
                <div id="shutdown" onclick="shutdown()">Shutdown</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize the map with a default location (fallback)
        let map = L.map('map').setView([51.505, -0.09], 13); // Centered on London
        let marker;
        let customMarkers = []; // Store custom markers
        let isAppRunning = true;
        let currentLanguage = 'device'; // Default to device language
        let deviceLang = navigator.language || navigator.userLanguage || 'en';
        deviceLang = deviceLang.split('-')[0]; // Simplify to primary language code
        let currentMapMode = 'roadmap'; // Default map mode, reset on load

        // Translation object
        const translations = {
            en: {
                pageTitle: "Live-Runners Map",
                menuButton: "Menu", // Not used since we're keeping the hamburger icon
                addPosition: "Add Position",
                removeAllPositions: "Remove All Positions (except current location)",
                mapMode: "Map Mode",
                mapModeRoadmap: "Roadmap",
                mapModeSatellite: "Satellite",
                mapModeHybrid: "Hybrid",
                shutdown: "Shutdown",
                addPositionPhonePrompt: "Enter mobile phone number (with country code, e.g., +972123456789):",
                addPositionNamePrompt: "Enter an optional name for this position (leave blank to skip):",
                invalidPhone: "Invalid phone number. Please include the country code (e.g., +972).",
                locationNotAvailable: "Location not available for this country code.",
                markerPopupTitle: (name, phone) => name || phone,
                removePosition: "Remove Position",
                mainMarkerPopup: (hasLocation) => hasLocation ? "Your current location!<br> You can zoom and pan the map." : "Default location (London)<br> You can zoom and pan the map.",
                mapAttribution: {
                    roadmap: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    satellite: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community',
                    hybrid: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
                },
                thankYouMessage: "Thank you for using Live-Runners Map",
                locationErrorDefault: "Unable to retrieve location. Using default location (London).",
                locationErrorPermission: "Location permission denied. Please allow location access in your browser settings and refresh the page.",
                locationErrorUnavailable: "Location information is unavailable. Please ensure location services are enabled on your device.",
                locationErrorTimeout: "Location request timed out. Please check your network connection and try again.",
                locationErrorUnknown: "An unknown error occurred while retrieving location.",
                locationErrorNotSupported: "Geolocation is not supported by your browser. Using default location (London).",
                httpsError: "This application requires a secure connection (HTTPS) to access your location. Please host the app on an HTTPS server or use a service like GitHub Pages."
            },
            he: {
                pageTitle: "מפת רצים חיה",
                menuButton: "תפריט", // Not used since we're keeping the hamburger icon
                addPosition: "הוסף מיקום",
                removeAllPositions: "הסר את כל המיקומים (למעט המיקום הנוכחי)",
                mapMode: "מצב מפה",
                mapModeRoadmap: "מפת דרכים",
                mapModeSatellite: "לוויין",
                mapModeHybrid: "היברידי",
                shutdown: "כיבוי",
                addPositionPhonePrompt: "הזן מספר טלפון נייד (עם קוד מדינה, לדוגמה, +972123456789):",
                addPositionNamePrompt: "הזן שם אופציונלי למיקום זה (השאר ריק כדי לדלג):",
                invalidPhone: "מספר טלפון לא תקין. אנא כלול את קוד המדינה (לדוגמה, +972).",
                locationNotAvailable: "המיקום אינו זמין עבור קוד מדינה זה.",
                markerPopupTitle: (name, phone) => name || phone,
                removePosition: "הסר מיקום",
                mainMarkerPopup: (hasLocation) => hasLocation ? "המיקום הנוכחי שלך!<br> ניתן להתקרב ולהזיז את המפה." : "מיקום ברירת מחדל (לונדון)<br> ניתן להתקרב ולהזיז את המפה.",
                mapAttribution: {
                    roadmap: 'נתוני מפה © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    satellite: '© Esri, Maxar, Earthstar Geographics, וקהילת משתמשי GIS',
                    hybrid: '© Esri, Maxar, Earthstar Geographics, וקהילת משתמשי GIS'
                },
                thankYouMessage: "תודה שהשתמשת במפת רצים חיה",
                locationErrorDefault: "לא ניתן לאחזר את המיקום. משתמש במיקום ברירת מחדל (לונדון).",
                locationErrorPermission: "הרשאת המיקום נדחתה. אנא אפשר גישה למיקום בהגדרות הדפדפן ורענן את הדף.",
                locationErrorUnavailable: "מידע המיקום אינו זמין. אנא ודא ששירותי המיקום מופעלים במכשיר שלך.",
                locationErrorTimeout: "בקשת המיקום פג תוקף. אנא בדוק את חיבור הרשת שלך ונסה שוב.",
                locationErrorUnknown: "אירעה שגיאה לא ידועה בעת אחזור המיקום.",
                locationErrorNotSupported: "הגיאולוקיישן אינו נתמך על ידי הדפדפן שלך. משתמש במיקום ברירת מחדל (לונדון).",
                httpsError: "יישום זה דורש חיבור מאובטח (HTTPS) כדי לגשת למיקום שלך. אנא ארח את היישום בשרת HTTPS או השתמש בשירות כמו GitHub Pages."
            }
        };

        // Set the device language button text
        document.getElementById('lang-device').textContent = deviceLang.toUpperCase();

        // Check if the page has been refreshed
        if (!localStorage.getItem('hasRefreshed')) {
            localStorage.setItem('hasRefreshed', 'false');
        }

        // Mapping of country codes to coordinates (simulated locations)
        const countryCodeLocations = {
            '+972': { lat: 32.0853, lng: 34.7818, name: 'Israel (Tel Aviv)' }, // Israel
            '+1': { lat: 40.7128, lng: -74.0060, name: 'USA (New York)' }, // USA
            '+44': { lat: 51.5074, lng: -0.1278, name: 'UK (London)' }, // UK
            '+33': { lat: 48.8566, lng: 2.3522, name: 'France (Paris)' }, // France
            '+81': { lat: 35.6762, lng: 139.6503, name: 'Japan (Tokyo)' } // Japan
        };

        // Function to get the current language's translations
        function getCurrentTranslations() {
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;
            return translations[lang] || translations.en; // Fallback to English
        }

        // Load custom locations from localStorage
        function loadCustomLocations() {
            const storedLocations = localStorage.getItem('customLocations');
            if (storedLocations) {
                customMarkers = JSON.parse(storedLocations).map(loc => {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                    marker.phone = loc.phone;
                    marker.country = loc.country;
                    marker.customName = loc.customName;
                    updateMarkerPopup(marker);
                    return marker;
                });
            }
        }

        // Save custom locations to localStorage
        function saveCustomLocations() {
            const locations = customMarkers.map(marker => ({
                lat: marker.getLatLng().lat,
                lng: marker.getLatLng().lng,
                phone: marker.phone,
                country: marker.country,
                customName: marker.customName
            }));
            localStorage.setItem('customLocations', JSON.stringify(locations));
        }

        // Function to update a marker's popup
        function updateMarkerPopup(marker) {
            const t = getCurrentTranslations();
            const title = t.markerPopupTitle(marker.customName, marker.phone);
            const popupContent = `
                <div class="custom-marker-popup">
                    <h3>${title}</h3>
                    <button onclick="removePosition('${marker.phone}')">${t.removePosition}</button>
                </div>
            `;
            marker.bindPopup(popupContent);
        }

        // Function to add a new position
        function addPosition() {
            if (!isAppRunning) return;

            const t = getCurrentTranslations();
            const phone = prompt(t.addPositionPhonePrompt);
            if (!phone) return; // User canceled or entered nothing

            // Extract country code (e.g., "+972")
            const countryCodeMatch = phone.match(/^\+(\d{1,3})/);
            if (!countryCodeMatch) {
                alert(t.invalidPhone);
                return;
            }

            const countryCode = countryCodeMatch[0];
            const locationData = countryCodeLocations[countryCode];
            if (!locationData) {
                alert(t.locationNotAvailable);
                return;
            }

            // Prompt for optional name
            const name = prompt(t.addPositionNamePrompt);
            const customName = name && name.trim() ? name.trim() : null;

            // Add marker at the simulated location
            const newMarker = L.marker([locationData.lat, locationData.lng]).addTo(map);
            newMarker.phone = phone;
            newMarker.country = locationData.name;
            newMarker.customName = customName;
            updateMarkerPopup(newMarker);
            customMarkers.push(newMarker);
            saveCustomLocations();
            togglePopupMenu(); // Close the popup menu
        }

        // Function to remove a specific position
        window.removePosition = function(phone) {
            const markerIndex = customMarkers.findIndex(m => m.phone === phone);
            if (markerIndex !== -1) {
                const marker = customMarkers[markerIndex];
                marker.remove(); // Remove from map
                customMarkers.splice(markerIndex, 1); // Remove from array
                saveCustomLocations(); // Update localStorage
            }
        };

        // Function to remove all positions (except current user location)
        function removeAllPositions() {
            if (!isAppRunning) return;

            customMarkers.forEach(marker => marker.remove());
            customMarkers = [];
            localStorage.removeItem('customLocations');
            togglePopupMenu(); // Close the popup menu
        }

        // Function to toggle the popup menu
        function togglePopupMenu() {
            const popupMenu = document.getElementById('popup-menu');
            const isOpen = popupMenu.classList.toggle('open');
            // Close map mode options if popup is closed
            if (!isOpen) {
                document.getElementById('map-mode-options').classList.remove('open');
            }
        }

        // Function to toggle map mode options
        function toggleMapModeOptions() {
            document.getElementById('map-mode-options').classList.toggle('open');
        }

        // Function to change map mode
        function changeMapMode(mode) {
            if (!isAppRunning) return;

            currentMapMode = mode;
            updateMapLanguage();
            togglePopupMenu(); // Close the popup menu
        }

        // Function to shutdown the application
        function shutdown() {
            if (!isAppRunning) return;

            isAppRunning = false;

            // Remove map, marker, and custom markers
            if (marker) marker.remove();
            customMarkers.forEach(m => m.remove());
            map.remove();
            localStorage.removeItem('customLocations');
            customMarkers = [];

            // Clear the entire page content
            document.body.innerHTML = '';

            // Display thank you message
            const t = getCurrentTranslations();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'thank-you-message';
            messageDiv.textContent = t.thankYouMessage;
            document.body.appendChild(messageDiv);
        }

        // Function to set the language and update UI
        function setLanguage(lang) {
            currentLanguage = lang;
            // Update selected button styling
            document.getElementById('lang-en').classList.toggle('selected', lang === 'en');
            document.getElementById('lang-device').classList.toggle('selected', lang === 'device');

            // Update all textual elements
            updateUIText();
            updateMapLanguage();
        }

        // Function to update all UI text based on the current language
        function updateUIText() {
            const t = getCurrentTranslations();
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;

            // Set RTL for the entire page
            const isRTL = ['ar', 'he', 'fa', 'ur'].includes(lang);
            document.body.setAttribute('dir', isRTL ? 'rtl' : 'ltr');

            // Update page title and heading
            document.getElementById('page-title').textContent = t.pageTitle;
            document.getElementById('page-heading').textContent = t.pageTitle;

            // Update popup menu items
            document.getElementById('add-position').textContent = t.addPosition;
            document.getElementById('remove-all-positions').textContent = t.removeAllPositions;
            document.getElementById('map-mode').textContent = t.mapMode;
            document.querySelector('label[for="roadmap"]').textContent = ` ${t.mapModeRoadmap}`;
            document.querySelector('label[for="satellite"]').textContent = ` ${t.mapModeSatellite}`;
            document.querySelector('label[for="hybrid"]').textContent = ` ${t.mapModeHybrid}`;
            document.getElementById('shutdown').textContent = t.shutdown;
        }

        // Function to update map language and marker
        function updateMapLanguage() {
            if (!isAppRunning) return;

            const t = getCurrentTranslations();
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;

            // Set text direction for the map
            const isRTL = ['ar', 'he', 'fa', 'ur'].includes(lang);
            document.getElementById('map').setAttribute('dir', isRTL ? 'rtl' : 'ltr');

            // Remove existing marker and tile layer
            if (marker) marker.remove();
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) map.removeLayer(layer);
            });

            // Add tile layer based on map mode
            let tileLayer;
            if (currentMapMode === 'roadmap') {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: t.mapAttribution.roadmap,
                    maxZoom: 19,
                });
            } else if (currentMapMode === 'satellite') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: t.mapAttribution.satellite,
                    maxZoom: 19,
                });
            } else if (currentMapMode === 'hybrid') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: t.mapAttribution.hybrid,
                    maxZoom: 19,
                });
                // Add a secondary layer for labels (hybrid mode)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '',
                    maxZoom: 19,
                    opacity: 0.4
                }).addTo(map);
            }
            tileLayer.addTo(map);

            // Customize popup based on language
            const hasLocation = window.currentLocation != null;
            const popupText = t.mainMarkerPopup(hasLocation);

            // Update marker with current or default location
            const location = window.currentLocation || [51.505, -0.09];
            marker = L.marker(location).addTo(map)
                .bindPopup(popupText)
                .openPopup();

            // Update custom markers' popups
            customMarkers.forEach(marker => updateMarkerPopup(marker));
        }

        // Function to get current location
        function getCurrentLocation() {
            const t = getCurrentTranslations();

            // Check for secure context (HTTPS)
            if (window.location.protocol !== 'https:') {
                alert(t.httpsError);
                window.currentLocation = null;
                updateMapLanguage();
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        window.currentLocation = [latitude, longitude];
                        map.setView(window.currentLocation, 13); // Center map on user location
                        updateMapLanguage(); // Update map with new location
                    },
                    error => {
                        let errorMessage = t.locationErrorDefault;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = t.locationErrorPermission;
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = t.locationErrorUnavailable;
                                break;
                            case error.TIMEOUT:
                                errorMessage = t.locationErrorTimeout;
                                break;
                            default:
                                errorMessage = t.locationErrorUnknown;
                                break;
                        }
                        console.error('Geolocation error:', error);
                        alert(errorMessage);
                        window.currentLocation = null;
                        updateMapLanguage();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error('Geolocation not supported');
                alert(t.locationErrorNotSupported);
                window.currentLocation = null;
                updateMapLanguage();
            }
        }

        // Add event listener for the menu button
        document.getElementById('menu-btn').addEventListener('click', togglePopupMenu);

        // Reset map mode to roadmap on initial load
        currentMapMode = 'roadmap';

        // Set default to device language and initialize UI
        setLanguage('device'); // Default to device language

        // Load custom locations
        loadCustomLocations();

        // Only fetch location if the page has been refreshed
        if (localStorage.getItem('hasRefreshed') === 'true') {
            getCurrentLocation();
        } else {
            window.currentLocation = null; // Ensure default location is used
            updateMapLanguage(); // Initialize map with default location
        }
    </script>
</body>
</html>
