<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Live-Runners Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --font-scale: 1; /* Default font size multiplier */
        }
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            position: relative;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: calc(36px * var(--font-scale));
        }
        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* Ensure right-to-left text for applicable languages */
        [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        /* Button bar container (language buttons and menu button) */
        .button-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 1000;
        }
        /* Shared button styling */
        .button-bar button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            font-size: calc(16px * var(--font-scale));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        /* Language button styling */
        .language-button, .menu-button {
            background-color: #666;
            color: white;
        }
        .language-button:hover, .menu-button:hover {
            background-color: #555;
        }
        .language-button.selected {
            background-color: #333;
            border: 2px solid #fff;
        }
        /* Popup menu styling */
        .popup-menu {
            display: none;
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            min-width: 180px;
            cursor: move; /* Indicate the menu is draggable */
        }
        .popup-menu.open {
            display: block;
        }
        .popup-menu div {
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
            font-size: calc(16px * var(--font-scale));
        }
        .popup-menu div:hover {
            background-color: #555;
        }
        /* Font size container */
        .font-size {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 3px;
        }
        .font-size span {
            flex: 1;
        }
        /* Map mode container */
        .map-mode {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 3px;
        }
        .map-mode span {
            flex: 1;
        }
        /* Map refresh container (now labeled as Refreshing) */
        .map-refresh {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 3px;
        }
        .map-refresh span {
            flex: 1;
        }
        .map-mode button, .map-refresh button {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            font-size: calc(14px * var(--font-scale));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #666;
            color: white;
            margin-left: 5px;
        }
        .map-mode button:hover, .map-refresh button:hover {
            background-color: #555;
        }
        .font-size button {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            font-size: calc(14px * var(--font-scale));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #666;
            color: white;
            margin-left: 5px;
        }
        .font-size button:hover {
            background-color: #555;
        }
        /* Add position form styling */
        .add-position-form {
            display: none;
            padding: 8px;
            background-color: #444;
            border-radius: 5px;
        }
        .add-position-form.open {
            display: block;
        }
        .add-position-form .phone-inputs {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }
        .add-position-form select,
        .add-position-form input {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 3px;
            background-color: #666;
            color: white;
            font-size: calc(14px * var(--font-scale));
        }
        .add-position-form select {
            flex: 1;
        }
        .add-position-form input[type="tel"] {
            flex: 2;
        }
        .add-position-form input[type="text"] {
            margin-bottom: 6px;
        }
        .add-position-form button {
            width: 100%;
            padding: 6px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: calc(14px * var(--font-scale));
        }
        .add-position-form button:hover {
            background-color: #666;
        }
        .add-position-form .error-message {
            color: #ff5555;
            font-size: calc(12px * var(--font-scale));
            margin-top: 5px;
            text-align: center;
        }
        /* Make placeholders more visible */
        .add-position-form input::placeholder {
            color: #ccc;
            font-size: calc(12px * var(--font-scale));
            opacity: 1;
        }
        /* Custom marker popup styling */
        .custom-marker-popup {
            text-align: center;
        }
        .custom-marker-popup h3 {
            margin: 0 0 10px 0;
            font-size: calc(18px * var(--font-scale));
        }
        .custom-marker-popup button {
            background-color: #666;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: calc(14px * var(--font-scale));
        }
        .custom-marker-popup button:hover {
            background-color: #555;
        }
        /* Thank you message styling */
        .thank-you-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: calc(26px * var(--font-scale));
            color: #333;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1 id="page-heading">Live-Runners Map</h1>
    <div class="map-wrapper">
        <div class="map-container" id="map-container">
            <div class="button-bar">
                <button class="language-button" id="lang-en" onclick="setLanguage('en')">EN</button>
                <button class="language-button" id="lang-device" onclick="setLanguage('device')"></button>
                <button class="menu-button" id="menu-btn">‚ò∞</button>
            </div>
            <div id="map"></div>
            <!-- Popup menu -->
            <div class="popup-menu" id="popup-menu">
                <div class="font-size">
                    <span id="font-size">Font Size</span>
                    <button onclick="increaseFontSize()">+</button>
                    <button onclick="decreaseFontSize()">‚àí</button>
                </div>
                <div id="add-position" onclick="toggleAddPositionForm()">Add Position</div>
                <div class="add-position-form" id="add-position-form">
                    <div class="phone-inputs">
                        <select id="position-country-code" onchange="updatePhoneNumberLength()">
                            <option value="+972">+972 (Israel)</option>
                            <option value="+1">+1 (USA)</option>
                            <option value="+44">+44 (UK)</option>
                            <option value="+33">+33 (France)</option>
                            <option value="+81">+81 (Japan)</option>
                        </select>
                        <input type="tel" id="position-phone" pattern="[0-9]*" maxlength="9">
                    </div>
                    <input type="text" id="position-name">
                    <button onclick="submitPosition()">Set on Map</button>
                    <div class="error-message" id="position-error"></div>
                </div>
                <div id="remove-all-positions" onclick="removeAllPositions()">Remove All Positions</div>
                <div class="map-mode">
                    <span id="map-mode">Map Mode</span>
                    <button onclick="changeMapMode('roadmap')">üõ§Ô∏è</button>
                    <button onclick="changeMapMode('satellite')">üõ∞Ô∏è</button>
                    <button onclick="changeMapMode('hybrid')">üó∫Ô∏è</button>
                </div>
                <div class="map-refresh">
                    <span id="map-refresh">Refreshing: 30 sec</span>
                    <button onclick="increaseRefreshInterval()">+</button>
                    <button onclick="decreaseRefreshInterval()">‚àí</button>
                </div>
                <div id="shutdown" onclick="shutdown()">Shutdown</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize the map with a default location (fallback) and zoomed in
        let map = L.map('map').setView([51.505, -0.09], 15);
        let marker;
        let customMarkers = [];
        let isAppRunning = true;
        let currentLanguage = 'device';
        let deviceLang = navigator.language || navigator.userLanguage || 'en';
        deviceLang = deviceLang.split('-')[0];
        let currentMapMode = 'roadmap';

        // Font size levels
        const fontSizeLevels = {
            small: 0.8,
            medium: 1.0,
            large: 1.2
        };
        let currentFontSizeLevel = 'medium'; // Default

        // Map refresh interval (in seconds)
        let refreshIntervalSeconds = 30; // Default: 30 seconds
        let refreshIntervalId = null;

        // Load font size from localStorage
        function loadFontSize() {
            const savedLevel = localStorage.getItem('fontSizeLevel');
            if (savedLevel && fontSizeLevels[savedLevel]) {
                currentFontSizeLevel = savedLevel;
                applyFontSize();
            }
        }

        // Apply font size multiplier
        function applyFontSize() {
            const multiplier = fontSizeLevels[currentFontSizeLevel];
            document.documentElement.style.setProperty('--font-scale', multiplier);
            localStorage.setItem('fontSizeLevel', currentFontSizeLevel);
        }

        // Increase font size
        function increaseFontSize() {
            if (currentFontSizeLevel === 'small') {
                currentFontSizeLevel = 'medium';
            } else if (currentFontSizeLevel === 'medium') {
                currentFontSizeLevel = 'large';
            }
            applyFontSize();
        }

        // Decrease font size
        function decreaseFontSize() {
            if (currentFontSizeLevel === 'large') {
                currentFontSizeLevel = 'medium';
            } else if (currentFontSizeLevel === 'medium') {
                currentFontSizeLevel = 'small';
            }
            applyFontSize();
        }

        // Increase refresh interval
        function increaseRefreshInterval() {
            if (refreshIntervalSeconds < 60) {
                refreshIntervalSeconds += 5;
                updateRefreshInterval();
            }
        }

        // Decrease refresh interval
        function decreaseRefreshInterval() {
            if (refreshIntervalSeconds > 5) {
                refreshIntervalSeconds -= 5;
                updateRefreshInterval();
            }
        }

        // Update refresh interval display and restart the timer
        function updateRefreshInterval() {
            const t = getCurrentTranslations();
            document.getElementById('map-refresh').textContent = `${t.mapRefresh}: ${refreshIntervalSeconds} sec`;
            // Clear the existing interval
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }
            // Start a new interval
            if (isAppRunning) {
                refreshIntervalId = setInterval(refreshMap, refreshIntervalSeconds * 1000);
            }
        }

        // Function to refresh the map (reload custom locations and update map)
        function refreshMap() {
            if (!isAppRunning) return;

            // Reload custom locations
            customMarkers.forEach(marker => marker.remove());
            customMarkers = [];
            loadCustomLocations();

            // Update the map
            updateMapLanguage();
        }

        // Translation object
        const translations = {
            en: {
                pageTitle: "Live-Runners Map",
                addPosition: "Add Position",
                fontSize: "Font Size",
                placeholderPhoneNumber: "Phone Number",
                placeholderName: "Optional Name",
                addPositionSubmit: "Set on Map",
                removeAllPositions: "Remove All Positions",
                mapMode: "Map Mode",
                mapRefresh: "Refreshing",
                shutdown: "Shutdown",
                invalidPhone: (maxLength) => `Invalid phone number. Must be up to ${maxLength} digits.`,
                invalidCountryCode: "Please select a valid country code.",
                locationNotAvailable: "Location not available for this country code.",
                markerPopupTitle: (name, phone) => name || phone,
                removePosition: "Remove Position",
                mainMarkerPopup: (hasLocation) => hasLocation ? "Your current location!<br> You can zoom and pan the map." : "Default location (London)<br> You can zoom and pan the map.",
                mapAttribution: {
                    roadmap: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    satellite: '¬© Esri, Maxar, Earthstar Geographics, and the GIS User Community',
                    hybrid: '¬© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
                },
                thankYouMessage: "Thank you for using Live-Runners Map",
                locationErrorDefault: "Unable to retrieve location. Using default location (London).",
                locationErrorPermission: "Location permission denied. Please allow location access in your browser settings and refresh the page.",
                locationErrorUnavailable: "Location information is unavailable. Please ensure location services are enabled on your device.",
                locationErrorTimeout: "Location request timed out. Please check your network connection and try again.",
                locationErrorUnknown: "An unknown error occurred while retrieving location.",
                locationErrorNotSupported: "Geolocation is not supported by your browser. Using default location (London).",
                httpsError: "This application requires a secure connection (HTTPS) to access your location. Please host the app on an HTTPS server or use a service like GitHub Pages."
            },
            he: {
                pageTitle: "◊û◊§◊™ ◊®◊¶◊ô◊ù ◊ó◊ô◊î",
                addPosition: "◊î◊ï◊°◊£ ◊û◊ô◊ß◊ï◊ù",
                fontSize: "◊í◊ï◊ì◊ú ◊í◊ï◊§◊ü",
                placeholderPhoneNumber: "◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü",
                placeholderName: "◊©◊ù ◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô",
                addPositionSubmit: "◊ß◊ë◊¢ ◊¢◊ú ◊î◊û◊§◊î",
                removeAllPositions: "◊î◊°◊® ◊ê◊™ ◊õ◊ú ◊î◊û◊ô◊ß◊ï◊û◊ô◊ù",
                mapMode: "◊û◊¶◊ë ◊û◊§◊î",
                mapRefresh: "◊û◊®◊¢◊†◊ü",
                shutdown: "◊õ◊ô◊ë◊ï◊ô",
                invalidPhone: (maxLength) => `◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü ◊ú◊ê ◊™◊ß◊ô◊ü. ◊ó◊ô◊ô◊ë ◊ú◊î◊õ◊ô◊ú ◊¢◊ì ${maxLength} ◊°◊§◊®◊ï◊™.`,
                invalidCountryCode: "◊ê◊†◊ê ◊ë◊ó◊® ◊ß◊ï◊ì ◊û◊ì◊ô◊†◊î ◊™◊ß◊ô◊ü.",
                locationNotAvailable: "◊î◊û◊ô◊ß◊ï◊ù ◊ê◊ô◊†◊ï ◊ñ◊û◊ô◊ü ◊¢◊ë◊ï◊® ◊ß◊ï◊ì ◊û◊ì◊ô◊†◊î ◊ñ◊î.",
                markerPopupTitle: (name, phone) => name || phone,
                removePosition: "◊î◊°◊® ◊û◊ô◊ß◊ï◊ù",
                mainMarkerPopup: (hasLocation) => hasLocation ? "◊î◊û◊ô◊ß◊ï◊ù ◊î◊†◊ï◊õ◊ó◊ô ◊©◊ú◊ö!<br> ◊†◊ô◊™◊ü ◊ú◊î◊™◊ß◊®◊ë ◊ï◊ú◊î◊ñ◊ô◊ñ ◊ê◊™ ◊î◊û◊§◊î." : "◊û◊ô◊ß◊ï◊ù ◊ë◊®◊ô◊®◊™ ◊û◊ó◊ì◊ú (◊ú◊ï◊†◊ì◊ï◊ü)<br> ◊†◊ô◊™◊ü ◊ú◊î◊™◊ß◊®◊ë ◊ï◊ú◊î◊ñ◊ô◊ñ ◊ê◊™ ◊î◊û◊§◊î.",
                mapAttribution: {
                    roadmap: '◊†◊™◊ï◊†◊ô ◊û◊§◊î ¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                    satellite: '¬© Esri, Maxar, Earthstar Geographics, ◊ï◊ß◊î◊ô◊ú◊™ ◊û◊©◊™◊û◊©◊ô GIS',
                    hybrid: '¬© Esri, Maxar, Earthstar Geographics, ◊ï◊ß◊î◊ô◊ú◊™ ◊û◊©◊™◊û◊©◊ô GIS'
                },
                thankYouMessage: "◊™◊ï◊ì◊î ◊©◊î◊©◊™◊û◊©◊™ ◊ë◊û◊§◊™ ◊®◊¶◊ô◊ù ◊ó◊ô◊î",
                locationErrorDefault: "◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊ê◊ó◊ñ◊® ◊ê◊™ ◊î◊û◊ô◊ß◊ï◊ù. ◊û◊©◊™◊û◊© ◊ë◊û◊ô◊ß◊ï◊ù ◊ë◊®◊ô◊®◊™ ◊û◊ó◊ì◊ú (◊ú◊ï◊†◊ì◊ï◊ü).",
                locationErrorPermission: "◊î◊®◊©◊ê◊™ ◊î◊û◊ô◊ß◊ï◊ù ◊†◊ì◊ó◊™◊î. ◊ê◊†◊ê ◊ê◊§◊©◊® ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊ï◊ù ◊ë◊î◊í◊ì◊®◊ï◊™ ◊î◊ì◊§◊ì◊§◊ü ◊ï◊®◊¢◊†◊ü ◊ê◊™ ◊î◊ì◊£.",
                locationErrorUnavailable: "◊û◊ô◊ì◊¢ ◊î◊û◊ô◊ß◊ï◊ù ◊ê◊ô◊†◊ï ◊ñ◊û◊ô◊ü. ◊ê◊†◊ê ◊ï◊ì◊ê ◊©◊©◊ô◊®◊ï◊™◊ô ◊î◊û◊ô◊ß◊ï◊ù ◊û◊ï◊§◊¢◊ú◊ô◊ù ◊ë◊û◊õ◊©◊ô◊® ◊©◊ú◊ö.",
                locationErrorTimeout: "◊ë◊ß◊©◊™ ◊î◊û◊ô◊ß◊ï◊ù ◊§◊í ◊™◊ï◊ß◊£. ◊ê◊†◊ê ◊ë◊ì◊ï◊ß ◊ê◊™ ◊ó◊ô◊ë◊ï◊® ◊î◊®◊©◊™ ◊©◊ú◊ö ◊ï◊†◊°◊î ◊©◊ï◊ë.",
                locationErrorUnknown: "◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ú◊ê ◊ô◊ì◊ï◊¢◊î ◊ë◊¢◊™ ◊ê◊ó◊ñ◊ï◊® ◊î◊û◊ô◊ß◊ï◊ù.",
                locationErrorNotSupported: "◊î◊í◊ô◊ê◊ï◊ú◊ï◊ß◊ô◊ô◊©◊ü ◊ê◊ô◊†◊ï ◊†◊™◊û◊ö ◊¢◊ú ◊ô◊ì◊ô ◊î◊ì◊§◊ì◊§◊ü ◊©◊ú◊ö. ◊û◊©◊™◊û◊© ◊ë◊û◊ô◊ß◊ï◊ù ◊ë◊®◊ô◊®◊™ ◊û◊ó◊ì◊ú (◊ú◊ï◊†◊ì◊ï◊ü).",
                httpsError: "◊ô◊ô◊©◊ï◊ù ◊ñ◊î ◊ì◊ï◊®◊© ◊ó◊ô◊ë◊ï◊® ◊û◊ê◊ï◊ë◊ò◊ó (HTTPS) ◊õ◊ì◊ô ◊ú◊í◊©◊™ ◊ú◊û◊ô◊ß◊ï◊ù ◊©◊ú◊ö. ◊ê◊†◊ê ◊ê◊®◊ó ◊ê◊™ ◊î◊ô◊ô◊©◊ï◊ù ◊ë◊©◊®◊™ HTTPS ◊ê◊ï ◊î◊©◊™◊û◊© ◊ë◊©◊ô◊®◊ï◊™ ◊õ◊û◊ï GitHub Pages."
            }
        };

        // Set the device language button text
        document.getElementById('lang-device').textContent = deviceLang.toUpperCase();

        // Mapping of country codes to coordinates (simulated locations)
        const countryCodeLocations = {
            '+972': { lat: 32.0853, lng: 34.7818, name: 'Israel (Tel Aviv)' },
            '+1': { lat: 40.7128, lng: -74.0060, name: 'USA (New York)' },
            '+44': { lat: 51.5074, lng: -0.1278, name: 'UK (London)' },
            '+33': { lat: 48.8566, lng: 2.3522, name: 'France (Paris)' },
            '+81': { lat: 35.6762, lng: 139.6503, name: 'Japan (Tokyo)' }
        };

        // Mapping of country codes to maximum phone number lengths (excluding country code)
        const countryCodeMaxLengths = {
            '+972': 9,
            '+1': 10,
            '+44': 10,
            '+33': 9,
            '+81': 10
        };

        // Mapping of language codes to country codes for default selection
        const languageToCountryCode = {
            'he': '+972',
            'en': '+1',
            'fr': '+33',
            'ja': '+81',
        };

        // Function to get the current language's translations
        function getCurrentTranslations() {
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;
            return translations[lang] || translations.en;
        }

        // Load custom locations from localStorage
        function loadCustomLocations() {
            const storedLocations = localStorage.getItem('customLocations');
            if (storedLocations) {
                customMarkers = JSON.parse(storedLocations).map(loc => {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                    marker.phone = loc.phone;
                    marker.country = loc.country;
                    marker.customName = loc.customName;
                    updateMarkerPopup(marker);
                    return marker;
                });
            }
        }

        // Save custom locations to localStorage
        function saveCustomLocations() {
            const locations = customMarkers.map(marker => ({
                lat: marker.getLatLng().lat,
                lng: marker.getLatLng().lng,
                phone: marker.phone,
                country: marker.country,
                customName: marker.customName
            }));
            localStorage.setItem('customLocations', JSON.stringify(locations));
        }

        // Function to update a marker's popup
        function updateMarkerPopup(marker) {
            const t = getCurrentTranslations();
            const title = t.markerPopupTitle(marker.customName, marker.phone);
            const popupContent = `
                <div class="custom-marker-popup">
                    <h3>${title}</h3>
                    <button onclick="removePosition('${marker.phone}')">${t.removePosition}</button>
                </div>
            `;
            marker.bindPopup(popupContent);
        }

        // Function to set the default country code based on user's language
        function setDefaultCountryCode() {
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;
            const defaultCountryCode = languageToCountryCode[lang] || '+1';
            document.getElementById('position-country-code').value = defaultCountryCode;
            updatePhoneNumberLength();
        }

        // Function to update the phone number input's maxlength based on selected country code
        function updatePhoneNumberLength() {
            const countryCode = document.getElementById('position-country-code').value;
            const maxLength = countryCodeMaxLengths[countryCode] || 10;
            document.getElementById('position-phone').setAttribute('maxlength', maxLength);
        }

        // Function to toggle the add position form
        function toggleAddPositionForm() {
            const form = document.getElementById('add-position-form');
            const isOpen = form.classList.toggle('open');
            if (isOpen) {
                document.getElementById('position-phone').value = '';
                document.getElementById('position-name').value = '';
                document.getElementById('position-error').textContent = '';
                setDefaultCountryCode();
                const t = getCurrentTranslations();
                document.getElementById('position-phone').placeholder = t.placeholderPhoneNumber;
                document.getElementById('position-name').placeholder = t.placeholderName;
                document.querySelector('#add-position-form button').textContent = t.addPositionSubmit;
            }
        }

        // Function to submit the position from the form
        function submitPosition() {
            if (!isAppRunning) return;

            const t = getCurrentTranslations();
            const countryCode = document.getElementById('position-country-code').value;
            const phoneNumber = document.getElementById('position-phone').value.trim();
            const name = document.getElementById('position-name').value.trim();
            const errorDiv = document.getElementById('position-error');

            if (!countryCode || !countryCodeLocations[countryCode]) {
                errorDiv.textContent = t.invalidCountryCode;
                return;
            }

            const maxLength = countryCodeMaxLengths[countryCode] || 10;
            if (!phoneNumber || !/^\d+$/.test(phoneNumber) || phoneNumber.length > maxLength) {
                errorDiv.textContent = t.invalidPhone(maxLength);
                return;
            }

            const phone = `${countryCode}${phoneNumber}`;
            const locationData = countryCodeLocations[countryCode];
            if (!locationData) {
                errorDiv.textContent = t.locationNotAvailable;
                return;
            }

            errorDiv.textContent = '';
            const customName = name ? name : null;
            const newMarker = L.marker([locationData.lat, locationData.lng]).addTo(map);
            newMarker.phone = phone;
            newMarker.country = locationData.name;
            newMarker.customName = customName;
            updateMarkerPopup(newMarker);
            customMarkers.push(newMarker);
            saveCustomLocations();

            toggleAddPositionForm();
            togglePopupMenu();
        }

        // Function to remove a specific position
        window.removePosition = function(phone) {
            const markerIndex = customMarkers.findIndex(m => m.phone === phone);
            if (markerIndex !== -1) {
                const marker = customMarkers[markerIndex];
                marker.remove();
                customMarkers.splice(markerIndex, 1);
                saveCustomLocations();
            }
        };

        // Function to remove all positions
        function removeAllPositions() {
            if (!isAppRunning) return;

            customMarkers.forEach(marker => marker.remove());
            customMarkers = [];
            localStorage.removeItem('customLocations');
            togglePopupMenu();
        }

        // Function to toggle the popup menu
        function togglePopupMenu() {
            const popupMenu = document.getElementById('popup-menu');
            const isOpen = popupMenu.classList.toggle('open');
            if (!isOpen) {
                document.getElementById('add-position-form').classList.remove('open');
            } else {
                // Reset position when opening to ensure it's visible
                popupMenu.style.left = '50%';
                popupMenu.style.top = '60px';
                popupMenu.style.transform = 'translateX(-50%)';
            }
        }

        // Function to change map mode
        function changeMapMode(mode) {
            if (!isAppRunning) return;

            currentMapMode = mode;
            updateMapLanguage();
        }

        // Function to shutdown the application
        function shutdown() {
            if (!isAppRunning) return;

            isAppRunning = false;
            if (marker) marker.remove();
            customMarkers.forEach(m => m.remove());
            map.remove();
            localStorage.removeItem('customLocations');
            customMarkers = [];

            // Clear the refresh interval
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }

            document.body.innerHTML = '';
            const t = getCurrentTranslations();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'thank-you-message';
            messageDiv.textContent = t.thankYouMessage;
            document.body.appendChild(messageDiv);
        }

        // Function to set the language and update UI
        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('lang-en').classList.toggle('selected', lang === 'en');
            document.getElementById('lang-device').classList.toggle('selected', lang === 'device');
            updateUIText();
            updateMapLanguage();
        }

        // Function to update all UI text based on the current language
        function updateUIText() {
            const t = getCurrentTranslations();
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;
            const isRTL = ['ar', 'he', 'fa', 'ur'].includes(lang);
            document.body.setAttribute('dir', isRTL ? 'rtl' : 'ltr');

            document.getElementById('page-title').textContent = t.pageTitle;
            document.getElementById('page-heading').textContent = t.pageTitle;
            document.getElementById('font-size').textContent = t.fontSize;
            document.getElementById('add-position').textContent = t.addPosition;
            document.getElementById('remove-all-positions').textContent = t.removeAllPositions;
            document.getElementById('map-mode').textContent = t.mapMode;
            document.getElementById('map-refresh').textContent = `${t.mapRefresh}: ${refreshIntervalSeconds} sec`;
            document.getElementById('shutdown').textContent = t.shutdown;
        }

        // Function to update map language and marker
        function updateMapLanguage() {
            if (!isAppRunning) return;

            const t = getCurrentTranslations();
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;
            const isRTL = ['ar', 'he', 'fa', 'ur'].includes(lang);
            document.getElementById('map').setAttribute('dir', isRTL ? 'rtl' : 'ltr');

            if (marker) marker.remove();
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) map.removeLayer(layer);
            });

            let tileLayer;
            if (currentMapMode === 'roadmap') {
                tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: t.mapAttribution.roadmap,
                    maxZoom: 19,
                });
            } else if (currentMapMode === 'satellite') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: t.mapAttribution.satellite,
                    maxZoom: 19,
                });
            } else if (currentMapMode === 'hybrid') {
                tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: t.mapAttribution.hybrid,
                    maxZoom: 19,
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '',
                    maxZoom: 19,
                    opacity: 0.4
                }).addTo(map);
            }
            tileLayer.addTo(map);

            const hasLocation = window.currentLocation != null;
            const popupText = t.mainMarkerPopup(hasLocation);
            const location = window.currentLocation || [51.505, -0.09];
            marker = L.marker(location).addTo(map)
                .bindPopup(popupText)
                .openPopup();
        }

        // Function to get current location
        function getCurrentLocation() {
            const t = getCurrentTranslations();
            if (window.location.protocol !== 'https:') {
                alert(t.httpsError);
                window.currentLocation = null;
                updateMapLanguage();
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        window.currentLocation = [latitude, longitude];
                        map.setView(window.currentLocation, 15);
                        updateMapLanguage();
                    },
                    error => {
                        let errorMessage = t.locationErrorDefault;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = t.locationErrorPermission;
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = t.locationErrorUnavailable;
                                break;
                            case error.TIMEOUT:
                                errorMessage = t.locationErrorTimeout;
                                break;
                            default:
                                errorMessage = t.locationErrorUnknown;
                                break;
                        }
                        console.error('Geolocation error:', error);
                        alert(errorMessage);
                        window.currentLocation = null;
                        updateMapLanguage();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error('Geolocation not supported');
                alert(t.locationErrorNotSupported);
                window.currentLocation = null;
                updateMapLanguage();
            }
        }

        // Make the popup menu draggable
        const popupMenu = document.getElementById('popup-menu');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;

        popupMenu.addEventListener('mousedown', startDragging);
        popupMenu.addEventListener('mousemove', drag);
        popupMenu.addEventListener('mouseup', stopDragging);
        popupMenu.addEventListener('mouseleave', stopDragging);

        // For touch support (mobile devices)
        popupMenu.addEventListener('touchstart', startDragging);
        popupMenu.addEventListener('touchmove', drag);
        popupMenu.addEventListener('touchend', stopDragging);

        function startDragging(e) {
            // Prevent dragging if interacting with menu items
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }

            isDragging = true;
            popupMenu.style.transform = 'none'; // Remove transform to use absolute positioning

            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - currentX;
                initialY = e.touches[0].clientY - currentY;
            } else {
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();

                let clientX, clientY;
                if (e.type === 'touchmove') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                currentX = clientX - initialX;
                currentY = clientY - initialY;

                // Boundary checks to keep the menu within the viewport
                const menuRect = popupMenu.getBoundingClientRect();
                const maxX = window.innerWidth - menuRect.width;
                const maxY = window.innerHeight - menuRect.height;

                currentX = Math.max(0, Math.min(currentX, maxX));
                currentY = Math.max(0, Math.min(currentY, maxY));

                popupMenu.style.left = currentX + 'px';
                popupMenu.style.top = currentY + 'px';
            }
        }

        function stopDragging() {
            isDragging = false;
        }

        // Add event listener for the menu button
        document.getElementById('menu-btn').addEventListener('click', togglePopupMenu);

        // Reset map mode to roadmap on initial load
        currentMapMode = 'roadmap';

        // Load font size preference
        loadFontSize();

        // Set default to device language and initialize UI
        setLanguage('device');

        // Load custom locations
        loadCustomLocations();

        // Fetch location on every load
        getCurrentLocation();

        // Start the initial refresh interval
        updateRefreshInterval();
    </script>
</body>
</html>
