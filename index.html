<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live-Runners Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            overflow-x: hidden;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        .button-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 1000;
        }
        .button-bar button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .language-button {
            background-color: #666;
            color: white;
        }
        .language-button:hover {
            background-color: #555;
        }
        .language-button.selected {
            background-color: #333;
            border: 2px solid #fff;
        }
        .menu-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background-color: #666;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        .menu-toggle:hover {
            background-color: #555;
        }
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background-color: #333;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            transition: left 0.3s ease-in-out;
            z-index: 2000;
        }
        .side-menu.open {
            left: 0;
        }
        .side-menu .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        .side-menu h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
        }
        .side-menu button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.3s;
        }
        .side-menu button:hover {
            background-color: #555;
        }
        .toast-bar {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 1001;
            text-align: center;
        }
        .minimize-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 20px;
            color: #333;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>Live-Runners Map</h1>
    <div class="map-wrapper">
        <div class="map-container" id="map-container">
            <button class="menu-toggle" onclick="toggleMenu()" title="Open Menu">☰</button>
            <div class="button-bar">
                <button class="language-button" id="lang-en" onclick="setLanguage('en')">EN</button>
                <button class="language-button" id="lang-device" onclick="setLanguage('device')"></button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="side-menu" id="side-menu">
        <button class="close-btn" onclick="toggleMenu()">×</button>
        <h2>Menu</h2>
        <button onclick="shutdownApp()">Minimize Application</button>
        <button onclick="refreshPage()">Refresh Map</button>
        <button onclick="addNewLocation()">Add New Location</button>
        <button onclick="addGasStations()">Add Gas Stations</button>
        <button onclick="forgetLocations()">Forget Locations</button>
    </div>

    <script>
        // Initialize variables
        let map;
        let marker;
        let customMarkers = [];
        let gasStationMarkers = [];
        let isAppRunning = true;
        let currentLanguage = 'device';
        let deviceLang = navigator.language || navigator.userLanguage || 'en';
        deviceLang = deviceLang.split('-')[0];
        let userLat = 51.505; // Default latitude (London)
        let userLng = -0.09;  // Default longitude (London)

        // Set the device language button text
        document.getElementById('lang-device').textContent = deviceLang.toUpperCase();

        // Check if the page has been refreshed
        if (!localStorage.getItem('hasRefreshed')) {
            localStorage.setItem('hasRefreshed', 'false');
        }

        // Mapping of country codes to coordinates (simulated locations)
        const countryCodeLocations = {
            '+972': { lat: 32.0853, lng: 34.7818, name: 'Israel (Tel Aviv)' },
            '+1': { lat: 40.7128, lng: -74.0060, name: 'USA (New York)' },
            '+44': { lat: 51.5074, lng: -0.1278, name: 'UK (London)' },
            '+33': { lat: 48.8566, lng: 2.3522, name: 'France (Paris)' },
            '+81': { lat: 35.6762, lng: 139.6503, name: 'Japan (Tokyo)' }
        };

        // Simulated gas stations data (hardcoded for demonstration)
        const gasStationsData = [
            { name: 'Shell', address: '123 King’s Road, London', lat: 51.4870, lng: -0.1688 },
            { name: 'BP', address: '456 High Street, London', lat: 51.5150, lng: -0.1410 },
            { name: 'Esso', address: '789 Station Road, Oxford', lat: 51.7520, lng: -1.2570 }
        ];

        // Red icon for gas stations
        let redIcon;
        try {
            redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        } catch (e) {
            console.error('Error loading red icon:', e);
            redIcon = L.Icon.Default;
        }

        // Function to calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Function to toggle the side menu
        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            menu.classList.toggle('open');
        }

        // Load custom locations from localStorage
        function loadCustomLocations() {
            try {
                const storedLocations = localStorage.getItem('customLocations');
                if (storedLocations) {
                    customMarkers = JSON.parse(storedLocations).map(loc => {
                        const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                        const popupText = currentLanguage === 'en'
                            ? `Location for ${loc.phone}: ${loc.country}`
                            : currentLanguage === 'he'
                            ? `מיקום עבור ${loc.phone}: ${loc.country}`
                            : `Location for ${loc.phone}: ${loc.country} (${currentLanguage})`;
                        marker.bindPopup(popupText);
                        return marker;
                    });
                }
            } catch (e) {
                console.error('Error loading custom locations from localStorage:', e);
                localStorage.removeItem('customLocations');
            }
        }

        // Load gas stations from localStorage
        function loadGasStations() {
            try {
                const storedGasStations = localStorage.getItem('gasStations');
                if (storedGasStations) {
                    const stations = JSON.parse(storedGasStations);
                    stations.forEach(station => {
                        const distance = calculateDistance(userLat, userLng, station.lat, station.lng);
                        if (distance <= 20) {
                            const marker = L.marker([station.lat, station.lng], { icon: redIcon }).addTo(map);
                            marker.bindPopup(station.popupText);
                            gasStationMarkers.push(marker);
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading gas stations from localStorage:', e);
                localStorage.removeItem('gasStations');
            }
        }

        // Save custom locations to localStorage
        function saveCustomLocations() {
            const locations = customMarkers.map(marker => ({
                lat: marker.getLatLng().lat,
                lng: marker.getLatLng().lng,
                phone: marker.phone,
                country: marker.country
            }));
            localStorage.setItem('customLocations', JSON.stringify(locations));
        }

        // Save gas stations to localStorage
        function saveGasStations() {
            const stations = gasStationMarkers.map(marker => ({
                lat: marker.getLatLng().lat,
                lng: marker.getLatLng().lng,
                popupText: marker.getPopup().getContent()
            }));
            localStorage.setItem('gasStations', JSON.stringify(stations));
        }

        // Function to add a new location based on phone number
        function addNewLocation() {
            if (!isAppRunning) return;

            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;
            const promptMessage = lang === 'en'
                ? 'Enter mobile phone number (with country code, e.g., +972123456789):'
                : lang === 'he'
                ? 'הזן מספר טלפון נייד (עם קוד מדינה, לדוגמה, +972123456789):'
                : `Enter mobile phone number (with country code): (${lang})`;

            const phone = prompt(promptMessage);
            if (!phone) return;

            const countryCodeMatch = phone.match(/^\+(\d{1,3})/);
            if (!countryCodeMatch) {
                const errorMessage = lang === 'en'
                    ? 'Invalid phone number. Please include the country code (e.g., +972).'
                    : lang === 'he'
                    ? 'מספר טלפון לא תקין. אנא כלול את קוד המדינה (לדוגמה, +972).'
                    : `Invalid phone number. Include country code. (${lang})`;
                alert(errorMessage);
                return;
            }

            const countryCode = countryCodeMatch[0];
            const locationData = countryCodeLocations[countryCode];
            if (!locationData) {
                const errorMessage = lang === 'en'
                    ? 'Location not available for this country code.'
                    : lang === 'he'
                    ? 'המיקום אינו זמין עבור קוד מדינה זה.'
                    : `Location not available for this country code. (${lang})`;
                alert(errorMessage);
                return;
            }

            const newMarker = L.marker([locationData.lat, locationData.lng]).addTo(map);
            const popupText = lang === 'en'
                ? `Location for ${phone}: ${locationData.name}`
                : lang === 'he'
                ? `מיקום עבור ${phone}: ${locationData.name}`
                : `Location for ${phone}: ${locationData.name} (${lang})`;
            newMarker.bindPopup(popupText);
            newMarker.phone = phone;
            newMarker.country = locationData.name;
            customMarkers.push(newMarker);
            saveCustomLocations();
            toggleMenu();
        }

        // Function to add gas stations within 20 km
        function addGasStations() {
            if (!isAppRunning) return;

            gasStationMarkers.forEach(marker => marker.remove());
            gasStationMarkers = [];

            gasStationsData.forEach(station => {
                const distance = calculateDistance(userLat, userLng, station.lat, station.lng);
                if (distance <= 20) {
                    const marker = L.marker([station.lat, station.lng], { icon: redIcon }).addTo(map);
                    const popupText = `${station.name}<br>${station.address}`;
                    marker.bindPopup(popupText);
                    gasStationMarkers.push(marker);
                }
            });

            saveGasStations();
            toggleMenu();
        }

        // Function to forget all custom locations and gas stations
        function forgetLocations() {
            if (!isAppRunning) return;

            customMarkers.forEach(marker => marker.remove());
            gasStationMarkers.forEach(marker => marker.remove());
            customMarkers = [];
            gasStationMarkers = [];
            localStorage.removeItem('customLocations');
            localStorage.removeItem('gasStations');
            toggleMenu();
        }

        // Function to set the language and update button styles
        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('lang-en').classList.toggle('selected', lang === 'en');
            document.getElementById('lang-device').classList.toggle('selected', lang === 'device');
            updateMapLanguage();
        }

        // Function to update map language and marker
        function updateMapLanguage() {
            if (!isAppRunning) return;

            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;

            // Set RTL for languages like Hebrew
            const isRTL = ['ar', 'he', 'fa', 'ur'].includes(lang);
            document.getElementById('map').setAttribute('dir', isRTL ? 'rtl' : 'ltr');

            // Remove existing marker and tile layer
            if (marker) marker.remove();
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) map.removeLayer(layer);
            });

            // Use CartoDB Voyager tiles (publicly accessible, better rendering)
            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png', {
                attribution: lang === 'en'
                    ? '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, © <a href="https://carto.com/attributions">CARTO</a>'
                    : lang === 'he'
                    ? 'נתוני מפה © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, © <a href="https://carto.com/attributions">CARTO</a>'
                    : `Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, © <a href="https://carto.com/attributions">CARTO</a> (${lang})`,
                maxZoom: 19,
                subdomains: 'abcd'
            }).addTo(map);

            // Customize popup based on language
            const hasLocation = window.currentLocation != null;
            const popupText = lang === 'en'
                ? (hasLocation ? 'Your current location!' : 'Default location (London)') + '<br> You can zoom and pan the map.'
                : lang === 'he'
                ? (hasLocation ? 'המיקום הנוכחי שלך!' : 'מיקום ברירת מחדל (לונדון)') + '<br> ניתן להתקרב ולהזיז את המפה.'
                : (hasLocation ? `Your location (${lang})` : `Default location (${lang})`) + '<br>Zoom and pan the map.';

            const location = window.currentLocation || [51.505, -0.09];
            marker = L.marker(location).addTo(map)
                .bindPopup(popupText)
                .openPopup();

            // Update custom markers' popups
            customMarkers.forEach(m => {
                const popupText = lang === 'en'
                    ? `Location for ${m.phone}: ${m.country}`
                    : lang === 'he'
                    ? `מיקום עבור ${m.phone}: ${m.country}`
                    : `Location for ${m.phone}: ${m.country} (${lang})`;
                m.setPopupContent(popupText);
            });

            // Update gas station markers' popups (addresses remain untranslated as proper nouns)
            gasStationMarkers.forEach(m => {
                m.setPopupContent(m.getPopup().getContent());
            });
        }

        // Function to shut down (minimize) the application with countdown
        function shutdownApp() {
            const lang = currentLanguage === 'device' ? deviceLang : currentLanguage;

            const confirmMessage = lang === 'en'
                ? 'Are you sure you want to minimize the application?'
                : lang === 'he'
                ? 'האם אתה בטוח שברצונך למזער את היישום?'
                : `Are you sure you want to minimize the application? (${lang})`;
            const userConfirmed = confirm(confirmMessage);

            if (!userConfirmed) return;

            isAppRunning = false;

            if (marker) marker.remove();
            customMarkers.forEach(m => m.remove());
            gasStationMarkers.forEach(m => m.remove());
            map.remove();
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = '';

            localStorage.removeItem('customLocations');
            localStorage.removeItem('gasStations');
            customMarkers = [];
            gasStationMarkers = [];

            const toast = document.createElement('div');
            toast.className = 'toast-bar';
            mapContainer.appendChild(toast);

            let countdown = 3;
            toast.textContent = lang === 'en'
                ? `Application will close in ${countdown}`
                : lang === 'he'
                ? `היישום ייסגר בעוד ${countdown}`
                : `Application will close in ${countdown} (${lang})`;

            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    toast.textContent = lang === 'en'
                        ? `Application will close in ${countdown}`
                        : lang === 'he'
                        ? `היישום ייסגר בעוד ${countdown}`
                        : `Application will close in ${countdown} (${lang})`;
                } else {
                    clearInterval(countdownInterval);
                    toast.remove();
                    const minimizeMessage = lang === 'en'
                        ? 'Please minimize the application by pressing the Home button'
                        : lang === 'he'
                        ? 'אנא מזער את היישום על ידי לחיצה על כפתור הבית'
                        : `Please minimize the application by pressing the Home button (${lang})`;
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'minimize-message';
                    messageDiv.textContent = minimizeMessage;
                    mapContainer.appendChild(messageDiv);
                }
            }, 1000);

            toggleMenu();
        }

        // Function to refresh the page
        function refreshPage() {
            localStorage.setItem('hasRefreshed', 'true');
            location.reload();
            toggleMenu();
        }

        // Function to get current location
        function getCurrentLocation() {
            if (window.location.protocol !== 'https:') {
                alert('This application requires a secure connection (HTTPS) to access your location. Please host the app on an HTTPS server or use a service like GitHub Pages.');
                window.currentLocation = null;
                updateMapLanguage();
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        window.currentLocation = [latitude, longitude];
                        userLat = latitude;
                        userLng = longitude;
                        map.setView(window.currentLocation, 13);
                        updateMapLanguage();
                        loadGasStations();
                    },
                    error => {
                        let errorMessage = 'Unable to retrieve location. Using default location (London).';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location permission denied. Please allow location access in your browser settings and refresh the page.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information is unavailable. Please ensure location services are enabled on your device.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out. Please check your network connection and try again.';
                                break;
                            default:
                                errorMessage = 'An unknown error occurred while retrieving location.';
                                break;
                        }
                        console.error('Geolocation error:', error);
                        alert(errorMessage);
                        window.currentLocation = null;
                        updateMapLanguage();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error('Geolocation not supported');
                alert('Geolocation is not supported by your browser. Using default location (London).');
                window.currentLocation = null;
                updateMapLanguage();
            }
        }

        // Initialize the map with error handling
        try {
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                throw new Error('Map container element not found');
            }
            map = L.map('map').setView([51.505, -0.09], 13);
            console.log('Map initialized successfully');
        } catch (e) {
            console.error('Error initializing map:', e);
            alert('Failed to initialize the map. Please check the console for details and try refreshing the page.');
            return;
        }

        // Set default to device language and initialize map
        setLanguage('device');

        // Load custom locations and gas stations
        loadCustomLocations();
        loadGasStations();

        // Only fetch location if the page has been refreshed
        if (localStorage.getItem('hasRefreshed') === 'true') {
            getCurrentLocation();
        } else {
            window.currentLocation = null;
            updateMapLanguage();
        }
    </script>
</body>
</html>
